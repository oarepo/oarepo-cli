version: "2.2"
services:
  cache:
    extends:
      file: docker-services.yml
      service: cache
    ports:
      - "${INVENIO_REDIS_HOST}:${INVENIO_REDIS_PORT}:6379"
  db:
    extends:
      file: docker-services.yml
      service: db
    ports:
      - "${INVENIO_DATABASE_HOST}:${INVENIO_DATABASE_PORT}:5432"
  mq:
    extends:
      file: docker-services.yml
      service: mq
    ports:
      - "${INVENIO_RABBIT_HOST}:${INVENIO_RABBIT_ADMIN_PORT}:15672"
      - "${INVENIO_RABBIT_HOST}:${INVENIO_RABBIT_PORT}:5672"
  search:
    extends:
      file: docker-services.yml
      service: search
    ports:
      - "${INVENIO_OPENSEARCH_HOST}:${INVENIO_OPENSEARCH_PORT}:9200"
      - "${INVENIO_OPENSEARCH_HOST}:${INVENIO_OPENSEARCH_CLUSTER_PORT}:9600"
{%- if cookiecutter.development_tools == "yes"%}
  opensearch-dashboards:
    extends:
      file: docker-services.yml
      service: opensearch-dashboards
    ports:
      - "${INVENIO_OPENSEARCH_DASHBOARD_HOST}:${INVENIO_OPENSEARCH_DASHBOARD_PORT}:5601"
    expose:
      - "5601"
  pgadmin:
    extends:
      file: docker-services.yml
      service: pgadmin
{%- endif %}

  s3:
    extends:
      file: docker-services.yml
      service: s3
    ports:
      - "${INVENIO_S3_HOST}:${INVENIO_S3_PORT}:9000"
      - "${INVENIO_S3_HOST}:${INVENIO_S3_PORT1}:9001"
  repo:
    image: oarepo/oarepo-base-development:11
    profiles:
      - repo
    user: ${INVENIO_DOCKER_USER_ID}
    ports:
      - '127.0.0.1:5000:5000'
    # restart: 'unless-stopped'
    environment:
      - 'INVENIO_ACCOUNTS_SESSION_REDIS_URL=redis://cache:6379/1'
      - 'INVENIO_BROKER_URL=amqp://guest:guest@mq:5672/'
      - 'INVENIO_CACHE_REDIS_URL=redis://cache:6379/0'
      - 'INVENIO_CACHE_TYPE=redis'
      - 'INVENIO_CELERY_BROKER_URL=amqp://guest:guest@mq:5672/'
      - 'INVENIO_CELERY_RESULT_BACKEND=redis://cache:6379/2'
      - "INVENIO_SEARCH_HOSTS=['search:9200']"
      - 'INVENIO_SECRET_KEY=CHANGE_ME'
      - "INVENIO_SQLALCHEMY_DATABASE_URI=postgresql+psycopg2://test:test@db/test"
      - 'INVENIO_RATELIMIT_STORAGE_URL=redis://cache:6379/3'
      - 'REPOSITORY_SITE_NAME=test'
    entrypoint: run
    stdin_open: true
    tty: true
    volumes:
      - type: bind
        source: ../../../
        target: /repository-parent
      - type: volume
        source: invenio
        target: /invenio
      - type: volume
        source: invenio-venv
        target: /invenio-venv
volumes:
  data:
  invenio:
  invenio-venv:
